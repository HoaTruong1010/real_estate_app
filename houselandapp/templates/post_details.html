{% extends 'layout/base.html' %}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/post_details.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
{% if n_images %}
<section>
    <div id="carouselExampleIndicators" class="carousel images slide" data-ride="carousel">
        {% if post.status.value == 'Đã được duyệt' %}
        <p style="background-color: #28a745; top: 3em; left: -12%;" class="sold_out">{{post.status.value}}</p>
        {%elif post.status.value in ['Chờ duyệt', 'Đã chỉnh sửa']%}
        <p style="background-color: #007bff;top: 2.5em;; left: -12%;" class="sold_out">{{post.status.value}}</p>
        {%else%}
        <p class="sold_out">{{post.status.value}}</p>
        {%endif%}
        <ol class="carousel-indicators">
            <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
            {% for i in range(1, n_images) %}
            <li data-target="#carouselExampleIndicators" data-slide-to="{{i}}"></li>
            {% endfor %}
        </ol>
        <div class="carousel-inner">
            <div class="carousel-item img-cover active">
                <img class="d-block img-carousel" src="{{post.images[0].url}}" alt="First slide">
            </div>
            {% for index in range(1,n_images)%}
            <div class="carousel-item img-cover">
                <img class="d-block img-carousel" src="{{post.images[index].url}}" alt="{{index}} slide">
            </div>
            {%endfor%}
        </div>
        <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
</section>
{%endif%}
<section>
    <div style="text-align: center;">
        <h4 style="font-size: 2rem; font-weight: 700; color: darksalmon;">{{post.title}}</h4>
    </div>
</section>
<div class="row justify-content-between">
    <div class="info col-7">
        <p style="font-size: 13px; margin: 10px 0 0 0px; color: grey; left: 0;">
            #Mã bài viết: {{post.id}}</p>
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            {% if duration < 0 or post.status.value in ['Đã cho thuê', 'Đã bán'] %}
            <p style="font-size: 13px; margin-bottom:0px; color: grey; left: 0;">
                <i class="fas fa-clock"></i> Đã được duyệt vào lúc {{post.created_at}}
            </p>
            {%else%}
            <p style="font-size: 13px; margin-bottom:0px; color: grey; left: 0;">
                <i class="fas fa-clock"></i> {{post.status.value}} vào lúc {{post.updated_at}}
            </p>
            {%endif%}

            {% if current_user.is_authenticated %}
            <div>
                {% if not post in report_list %}
                <a class="btn btn-outline-warning" href="javascript:;" title="Report"
                    style="font-size: 13px; width: 40px; height: 30px; margin: 10px 0 0 10px;"
                    onclick="report(`{{post.id}}`)">
                    <i class="far fa-flag"></i>
                </a>
                {% else %}
                <a class="btn btn-warning" href="javascript:;" title="Report"
                    style="font-size: 13px; width: 40px; height: 30px; margin: 10px 0 0 10px;"
                    onclick="report(`{{post.id}}`)">
                    <i style="color: white;" class="far fa-flag"></i>
                </a>
                {% endif %}
                {% if post in saved_list %}
                <a class="btn btn-danger {{post.id}}" href="javascript:;" title="Saved" onclick="reactPost(`{{post.id}}`)"
                    style="font-size: 13px; width: 40px; height: 30px; margin: 10px 0 0 10px;">
                    <i class="far fa-bookmark"></i>
                </a>
                {% else %}
                <a class="btn btn-outline-danger {{post.id}}" href="javascript:;" title="Save"
                    onclick="reactPost(`{{post.id}}`)"
                    style="font-size: 13px; width: 40px; height: 30px; margin: 10px 0 0 10px;">
                    <i class="far fa-bookmark"></i>
                </a>
                {% endif %}
            </div>
            {%else%}
            <a class="btn btn-outline-warning" href="/login_register?next=/posts/{{post.id}}" title="Report"
                style="font-size: 13px; width: 40px; height: 30px; margin: 10px 0 0 10px;">
                <i class="far fa-flag"></i>
            </a>
            <a class="btn btn-outline-danger {{post.id}}" href="/login_register?next=/posts/{{post.id}}" title="Save"
            style="font-size: 13px; width: 40px; height: 30px; margin: 10px 0 0 10px;">
            <i class="far fa-bookmark"></i></a>
            {% endif %}
        </div>
        <hr>
        <p style="color: red;"><i class="fas fa-dollar-sign"></i> <b>Giá:</b> <span
                class="display-price">{{post.price}}</span>{%if not
            post.issales%}<span>/tháng</span>{%endif%}</p>
        <p><i class='fas fa-map-marker-alt'></i> <b>Địa chỉ: </b> <span id="p-a">{{post.address}}</span> </p>
        <p><i class="fab fa-windows"></i> <b>Diện tích:</b>
            {{"{:,}".format(post.area)}}
            m<sup>2</sup></p>
        {% if duration < 0%}
        <p><i class='fas fa-clock'></i> <b>Ngày hết hạn:</b> {{post.expire_at}}</p>
        {%else%}
        <p><i class='fas fa-clock'></i> <b>Ngày hết hạn:</b> Còn {{duration}} ngày nữa</p>
        {%endif%}
        <hr>
        <p><i class="fas fa-scroll"></i> <b>Mô tả:</b></p>
        <textarea cols="80" class="py-2 px-3" rows="10" disabled>{{post.description}}</textarea>
        <div class="feature">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col"><h5 style="color: darkred;">Đặc điểm bất động sản</h5></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row"><i class="fab fa-windows"></i> Diện tích:</th>
                        <td>{{"{:,}".format(post.area)}} m<sup>2</sup></td>
                    </tr>
                    {% if post.bedrooms != 0 %}
                    <tr>
                        <th scope="row"><i class="fas fa-bed"></i> Số lượng phòng ngủ:</th>
                        <td>{{post.bedrooms}} phòng</td>
                    </tr>
                    {% endif %}
                    {% if post.bathrooms != 0 %}
                    <tr>
                        <th scope="row"><i class="fas fa-toilet"></i> Số lượng phòng WC:</th>
                        <td>{{post.bathrooms}} phòng</td>
                    </tr>
                    {% endif %}

                    {% if post.floor != 0 %}
                    <tr>
                        <th scope="row"><i class="fas fa-building"></i> Số tầng:</th>
                        <td>{{post.floor}} tầng</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th scope="row"><i class="fas fa-dollar-sign"></i> Giá:</th>
                        <td><span class="display-price">{{post.price}}</span>{%if not
                            post.issales%}<span>/tháng</span>{%endif%}</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="fas fa-bookmark"></i> Danh mục:</th>
                        <td>{{issales}} {{cate_name}}</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="fas fa-scroll"></i> Giấy tờ pháp lý:</th>
                        <td>{{post.policy}}</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="fas fa-tag"></i> Loại hình BĐS:</th>
                        <td>{{post.type}}</td>
                    </tr>
                    {% if post.direction %}
                    <tr>
                        <th scope="row"><i class="fas fa-directions"></i> Hướng:</th>
                        <td>{{post.direction}} </td>
                    </tr>
                    {% endif %}
                    {% if post.furniture %}
                    <tr>
                        <th scope="row"><i class="fas fa-couch"></i> Tình trạng nội thất:</th>
                        <td>{{post.furniture}}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <h5 style="color: darkred;">Địa điểm bất động sản</h5>
        <div class="d-flex justify-content-center">
            <div id="map" style="width: 100%; height: 400px;" ></div>
        </div>
    </div>

    <div class="user-card col-4">
        <div class="card" style="width: 18rem;">
            <img class="card-img-top" src="{{author.avatar}}" alt="Card image cap">
            <div class="card-body">
                <h5 style="color: darkcyan;" class="card-title">{{author.name}}</h5>
                <p class="card-text"><i class="fas fa-mobile"></i> {{author.phone}}</p>
                <a href="javascript:;" onclick="create(`{{current_user.id}}`, `{{author.id}}`)" class="btn btn-success">Nhắn
                    tin</a>
                <a href="/profile/{{author_id}}" class="btn btn-primary mt-2">Xem trang cá nhân</a>
            </div>
        </div>
        {% if all_reports and current_user.user_role == admin %}
        <div class="mt-5">
            <h5 style="color: red;" class="card-title">BÁO CÁO</h5>
            <div class="d-flex justify-content-between" style="width: 18rem;">
            </div>
            {% for i in range(0, all_reports.__len__()) %}
            <div class="card mt-3" style="width: 18rem;">
                <div class="card-body">
                  <h5 class="card-title">{{usr_reports[i].name}} (ID: {{usr_reports[i].id}})</h5>
                  <h6 class="card-subtitle mb-2 text-muted">{{all_reports[i].date_report}}</h6>
                  <p class="card-text">{{all_reports[i].content}}</p>
                  {% if all_reports[i].date_handle %}
                  <p href="javascript:void(0)"class="mt-3 text-danger">Đã xử lý ({{all_reports[i].date_handle}})</p>
                  {%else%}
                  <a href="javascript:void(0)" onclick="action(`{{all_reports[i].user_id}}`, 'recovery', `{{post.id}}`)" class="card-link">Khôi phục bài viết</a>
                  <a href="javascript:void(0)" onclick="action(`{{all_reports[i].user_id}}`, 'hide', `{{post.id}}`)" class="card-link text-danger">Ẩn bài viết</a>
                  {% endif %}
                </div>
            </div>
            {%endfor%}
        </div>
        {%endif%}
    </div>
</div>


<div class="hint" id="similar">
    <h4 style="color: goldenrod;">Tin đăng tương tự</h4>
    <hr>
    <div class="cards flex justify-content-start" style="flex-wrap: wrap;" id="cards"></div>
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-end" id="hint"></ul>
    </nav>
    <hr>
</div>

{% if author_posts %}
<div class="hint">
    <h4 style="color: goldenrod;">Tin đăng khác của {{author.name}}</h4>
    <hr>
    <div class="cards flex justify-content-start" style="flex-wrap: wrap;" id="cards">
        {% for i in range(0, 4) %}
        <div class="card hint-card">
            <div class="card-image"><img class="card-img-top" src="{{author_posts[i].images[0]}}" alt="Card image cap"></div>
            <div class="hint-address">
                <p><i class="fas fa-map-marker-alt"></i> {{author_posts[i].address}}
                </p>
            </div>
            <div class="card-body">
                <h5 class="card-title">{{author_posts[i].title}}</h5>
                <p><i class="fab fa-windows"></i> <b>Diện tích:</b>
                    {{"{:,}".format(author_posts[i].area)}}
                    m<sup>2</sup></p>
                <p><i class="fas fa-dollar-sign"></i> Giá: <span class="display-price">{{author_posts[i].price}}</span>
                </p>
                <a href="/posts/{{author_posts[i].id}}" class="btn btn-primary">Xem bài viết</a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if author_posts.__len__() > 4 %}
    <div class="w-100 d-flex justify-content-end"><a class="link-offset-2 link-underline link-underline-opacity-25" style="width: 150px; text-underline-offset: 0.25em; font-weight: bold;" href="/profile/{{author_id}}" aria-label="Previous">
        Xem thêm <i class="fas fa-chevron-right"></i>
    </a></div>
    
    {%endif%}
    <hr>
</div>
{%endif%}

{% if viewed_list %}
<div class="hint">
    <h4 style="color: goldenrod;">Bài viết đã xem</h4>
    <hr>
    <div class="cards flex justify-content-start" style="flex-wrap: wrap;" id="cards">
        {% for i in range(0, 4) %}
        {%if i < viewed_list.__len__()%}
        <div class="card hint-card">
            <div class="card-image"><img class="card-img-top" src="{{viewed_list[i].images[0]}}" alt="Card image cap"></div>
            <div class="hint-address">
                <p><i class="fas fa-map-marker-alt"></i> {{viewed_list[i].address}}
                </p>
            </div>
            <div class="card-body">
                <h5 class="card-title">{{viewed_list[i].title}}</h5>
                <p><i class="fab fa-windows"></i> <b>Diện tích:</b>
                    {{"{:,}".format(viewed_list[i].area)}}
                    m<sup>2</sup></p>
                <p><i class="fas fa-dollar-sign"></i> Giá:  <span class="display-price">{{viewed_list[i].price}}</span>
                </p>
                <a href="/posts/{{viewed_list[i].id}}" class="btn btn-primary">Xem bài viết</a>
            </div>
        </div>
        {%endif%}
        {% endfor %}
    </div>
    {% if viewed_list.__len__() > 4 %}
    <div class="w-100 d-flex justify-content-end"><a class="link-offset-2 link-underline link-underline-opacity-25" style="width: 150px; text-underline-offset: 0.25em; font-weight: bold;" href="/profile/{{current_user_id}}?viewed=true" aria-label="Previous">
        Xem thêm <i class="fas fa-chevron-right"></i>
    </a></div>
    
    {%endif%}
    <hr>
</div>
{%endif%}
{% endblock %}


{% block js %}
<script src="{{ url_for('static', filename='js/react.js') }}"></script>
<script src="{{ url_for('static', filename='js/post_details.js') }}"></script>
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
<script src="{{ url_for('static', filename='js/new_conversation.js') }}"></script>
<script>
    window.onload = function () {
        $("html, body").animate(
            {
            scrollTop: 730,
            },
            1000
        );
        createHintPosts(`{{ post.id }}`);
        const unit = ['VNĐ', 'nghìn đồng', 'triệu đồng', 'tỷ đồng']
        $('.display-price').html((idx, item) => {
            let i = 0;
            var price = parseFloat(item);
            while (price >= 1000) {
                if (i == 3) {
                    break;
                }
                i = i + 1;
                price = price / 1000;
            }
            console.log(price)
            return ` ${price} ${unit[i]}`;

        });
        $('#p-a').text((idx, item) => {
            return item.split("Xem")[0]
        });
        var map = L.map('map').setView([`{{post.lat}}`, `{{post.lon}}`], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
        var marker = L.marker([`{{post.lat}}`, `{{post.lon}}`]).addTo(map);
    }
</script>
{% endblock %}